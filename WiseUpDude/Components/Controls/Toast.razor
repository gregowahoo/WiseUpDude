@inject WiseUpDude.Shared.Services.ToastService ToastService

@implements IDisposable

<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1100;">
    @if (visible)
    {
        <div class="toast show @GetToastClass()" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-body">
                @message
            </div>
        </div>
    }
</div>

@code {
    private string message = "";
    private bool visible = false;
    private ToastLevel level = ToastLevel.Info;
    private System.Threading.Timer? timer;

    protected override void OnInitialized()
    {
        ToastService.OnShow += ShowToast;
    }

    private async Task ShowToast(string msg, ToastLevel toastLevel)
    {
        try
        {

            Console.Error.WriteLine($"In Show Toast");

            message = msg;
            level = toastLevel;
            visible = true;
            await InvokeAsync(StateHasChanged);

            timer?.Dispose();
            timer = new System.Threading.Timer(async _ =>
            {
                try
                {
                    visible = false;
                    await InvokeAsync(StateHasChanged);
                    timer?.Dispose();
                }
                catch (Exception timerEx)
                {
                    Console.Error.WriteLine($"[Toast Timer Error] {timerEx}");
                }
            }, null, 3000, System.Threading.Timeout.Infinite);
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"[Toast ShowToast Error] {ex}");
        }
    }

    // Unsubscribe and dispose timer when the component is disposed
    public void Dispose()
    {
        ToastService.OnShow -= ShowToast;
        timer?.Dispose();
    }

    private string GetToastClass() => level switch
    {
        ToastLevel.Success => "bg-success text-white",
        ToastLevel.Error => "bg-danger text-white",
        ToastLevel.Warning => "bg-warning text-dark",
        _ => "bg-info text-white"
    };
}