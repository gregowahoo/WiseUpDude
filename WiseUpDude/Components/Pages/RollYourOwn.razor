@page "/rollyourown"

@using Microsoft.AspNetCore.Authorization
@using WiseUpDude.Services
@using WiseUpDude.Services.Interfaces
@using WiseUpDude.Model
@using WiseUpDude.Data.Repositories

@inject QuizRepository QuizRepository
@inject UserQuizRepository UserQuizRepository
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject IQuizFromPromptService QuizGenerationService
@inject WiseUpDude.Services.PerplexityService PerplexityService
@inject ILogger<RollYourOwn> Logger
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ITenorGifService TenorGifService
@inject IPromptSuggestionCacheService PromptCache
@inject IUrlSuggestionCacheService UrlCache

@rendermode InteractiveServer
@attribute [Authorize]
@attribute [StreamRendering(true)]

@if (IsGenerating || IsSaving)
{
    <PleaseWaitDialog IsVisible="IsGenerating || IsSaving"
                      LoadingTextMessage="@($"Preparing your \"{UserPrompt}\" quiz...")" />
}
@if (IsUrlGenerating)
{
    <PleaseWaitDialog IsVisible="IsUrlGenerating"
                      LoadingTextMessage="@($"Preparing your quiz from the URL: \"{QuizUrl}\"...")" />
}

<div class="container py-5">
    <!-- Header Section -->
    <div class="text-center mb-5">
        <h1 class="display-4 fw-bold text-primary">🎲 Roll Your Own Quiz</h1>
        <p class="lead text-muted">
            Create a quiz from a custom prompt or a web URL. Fast, fun, and easy!<br />
            <span class="ryo-banner-note">Note: Quiz data may be slightly out of date, especially for fast-changing topics like sports or news.</span>
        </p>
    </div>

    <div class="ryo-card-container">
        <div class="ryo-tabs">
            <button class="ryo-tab-btn @(ActiveTab == 0 ? "active" : null)" @onclick="() => SetTab(0)">
                <i class="bi bi-lightbulb"></i> Custom Prompt
            </button>
            <button class="ryo-tab-btn @(ActiveTab == 1 ? "active" : null)" @onclick="() => SetTab(1)">
                <i class="bi bi-link-45deg"></i> From URL
            </button>
            <div class="ryo-tab-indicator" style="left:@(ActiveTab * 50)%"></div>
        </div>

        <div class="ryo-tab-content">
            @if (ActiveTab == 0)
            {
                <div class="ryo-form-card">
                    <div class="ryo-form-group">
                        <div class="ryo-form-label-row">
                            <label for="promptDropdown">Example Prompts</label>
                            <button class="ryo-refresh-btn" title="Refresh Prompts" @onclick="RefreshPromptsAsync" disabled="@IsLoadingPrompts">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                        <select id="promptDropdown" class="form-select" @onchange="OnPromptDropdownChanged" disabled="@IsLoadingPrompts">
                            <option value="">Choose an example...</option>
                            @if (SuggestedPrompts != null)
                            {
                                @foreach (var prompt in SuggestedPrompts)
                                {
                                    <option value="@prompt">@prompt</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="ryo-form-group">
                        <label for="promptInput">What would you like to learn about?</label>
                        <InputTextArea id="promptInput" @bind-Value="UserPrompt" class="form-control ryo-input" placeholder="e.g. The history of space exploration, quantum physics basics, cooking techniques..." Rows="4" @onkeydown="HandlePromptKeyDown" />
                    </div>
                    <div class="ryo-form-actions">
                        <button class="ryo-action-btn ryo-action-success" @onclick="GenerateAndSaveQuizFromPrompt" disabled="@(IsGenerating || IsSaving || string.IsNullOrWhiteSpace(UserPrompt))">
                            🚀 Generate Quiz
                        </button>
                    </div>
                    @if (!string.IsNullOrEmpty(ErrorMessage))
                    {
                        <div class="alert alert-danger mt-3" role="alert">
                            @ErrorMessage
                        </div>
                    }
                </div>
            }
            else if (ActiveTab == 1)
            {
                <div class="ryo-form-card">
                    <div class="ryo-form-group">
                        <div class="ryo-form-label-row">
                            <label for="urlDropdown">Example URLs</label>
                            <button class="ryo-refresh-btn" title="Refresh URLs" @onclick="RefreshUrlsAsync" disabled="@IsLoadingUrls">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                        <select id="urlDropdown" class="form-select" @onchange="OnUrlDropdownChanged" disabled="@IsLoadingUrls">
                            <option value="">Choose an example...</option>
                            @if (SuggestedUrls != null)
                            {
                                @foreach (var url in SuggestedUrls)
                                {
                                    <option value="@url">@url</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="ryo-form-group">
                        <label for="urlInput">Enter the URL of an article or webpage:</label>
                        <InputText id="urlInput" @bind-Value="QuizUrl" class="form-control ryo-input" placeholder="e.g. https://en.wikipedia.org/wiki/Space_exploration" />
                    </div>
                    <div class="ryo-form-actions">
                        <button class="ryo-action-btn ryo-action-primary" @onclick="GenerateAndSaveQuizFromUrl" disabled="@(IsUrlGenerating || string.IsNullOrWhiteSpace(QuizUrl))">
                            🔗 Generate Quiz
                        </button>
                    </div>
                    @if (!string.IsNullOrEmpty(UrlErrorMessage))
                    {
                        <div class="alert alert-danger mt-3" role="alert">
                            @UrlErrorMessage
                        </div>
                    }
                </div>
            }
        </div>
    </div>
</div>

@code {
    private int ActiveTab { get; set; } = 0;
    private string? UserPrompt { get; set; }
    private string? QuizUrl { get; set; }
    private bool IsGenerating = false;
    private bool IsSaving = false;
    private string? ErrorMessage;
    private string? UrlErrorMessage;
    private bool IsUrlGenerating = false;
    private List<string> SuggestedPrompts = new();
    private bool IsLoadingPrompts = false;
    private bool promptSelected = false;
    private List<string> SuggestedUrls = new();
    private bool IsLoadingUrls = false;
    private bool urlSelected = false;

    protected override void OnInitialized()
    {
        _ = LoadPromptsAsync();
        _ = LoadUrlsAsync();
    }

    private async Task LoadPromptsAsync()
    {
        IsLoadingPrompts = true;
        await InvokeAsync(StateHasChanged);

        var cachedPrompts = PromptCache.GetPrompts();
        if (PromptCache.HasPrompts() && cachedPrompts != null)
        {
            SuggestedPrompts = new List<string>(cachedPrompts);
        }
        else
        {
            var (prompts, error) = await PerplexityService.GenerateSuggestedPromptsAsync();
            if (prompts != null)
            {
                SuggestedPrompts = prompts.ToList();
                PromptCache.SetPrompts(prompts);
            }
            else
            {
                Logger.LogError("Failed to load suggested prompts: {Error}", error);
            }
        }

        IsLoadingPrompts = false;
        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadUrlsAsync()
    {
        IsLoadingUrls = true;
        await InvokeAsync(StateHasChanged);

        var cachedUrls = UrlCache.GetUrls();
        if (UrlCache.HasUrls() && cachedUrls != null)
        {
            SuggestedUrls = new List<string>(cachedUrls);
        }
        else
        {
            var (urls, error) = await PerplexityService.GenerateSuggestedUrlsAsync();
            if (urls != null)
            {
                SuggestedUrls = urls.ToList();
                UrlCache.SetUrls(urls);
            }
            else
            {
                Logger.LogError("Failed to load suggested URLs: {Error}", error);
            }
        }

        IsLoadingUrls = false;
        await InvokeAsync(StateHasChanged);
    }

    private async Task RefreshPromptsAsync()
    {
        IsLoadingPrompts = true;
        await InvokeAsync(StateHasChanged);
        var (prompts, error) = await PerplexityService.GenerateSuggestedPromptsAsync();
        if (prompts != null)
        {
            SuggestedPrompts = prompts.ToList();
            PromptCache.SetPrompts(prompts);
        }
        else
        {
            Logger.LogError("Failed to load suggested prompts: {Error}", error);
        }
        IsLoadingPrompts = false;
        await InvokeAsync(StateHasChanged);
    }

    private async Task RefreshUrlsAsync()
    {
        IsLoadingUrls = true;
        await InvokeAsync(StateHasChanged);
        var (urls, error) = await PerplexityService.GenerateSuggestedUrlsAsync();
        if (urls != null)
        {
            SuggestedUrls = urls.ToList();
            UrlCache.SetUrls(urls);
        }
        else
        {
            Logger.LogError("Failed to load suggested URLs: {Error}", error);
        }
        IsLoadingUrls = false;
        await InvokeAsync(StateHasChanged);
    }

    private void SetTab(int tab)
    {
        ActiveTab = tab;
        ErrorMessage = null;
        UrlErrorMessage = null;
        promptSelected = false;
        urlSelected = false;
    }

    private async Task HandlePromptKeyDown(KeyboardEventArgs e)
    {
        if (e.CtrlKey && e.Key == "Enter" && !IsGenerating && !IsSaving && !string.IsNullOrWhiteSpace(UserPrompt))
        {
            await GenerateAndSaveQuizFromPrompt();
        }
    }

    private async Task GenerateAndSaveQuizFromPrompt()
    {
        if (string.IsNullOrWhiteSpace(UserPrompt))
        {
            ErrorMessage = "Please enter a valid prompt.";
            return;
        }

        IsGenerating = true;
        IsSaving = true;
        ErrorMessage = null;
        await InvokeAsync(StateHasChanged);

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var userId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value
                   ?? user.FindFirst("sub")?.Value;

        try
        {
            Logger.LogInformation("Sending prompt to PerplexityService: {UserPrompt}", UserPrompt);
            var (quiz, error) = await PerplexityService.GenerateQuizFromPromptAsync(UserPrompt, userId);
            if (quiz == null)
            {
                Logger.LogError("PerplexityService returned no quiz. Error: {Error}", error);
                ErrorMessage = error ?? "Failed to generate quiz from prompt. Please try again.";
                return;
            }
            var userQuizId = await UserQuizRepository.AddAsyncGetId(quiz);
            Logger.LogInformation("Quiz successfully saved to the UserQuiz table. QuizId: {QuizId}", userQuizId);
            NavigationManager.NavigateTo($"/TakeAQuiz/{userQuizId}");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Exception during quiz save.");
            ErrorMessage = "An error occurred while generating or saving the quiz. Please try again later.";
        }
        finally
        {
            IsGenerating = false;
            IsSaving = false;
            if (!promptSelected)
            {
                await InvokeAsync(StateHasChanged);
            }
        }
    }

    private async Task GenerateAndSaveQuizFromUrl()
    {
        UrlErrorMessage = null;
        if (string.IsNullOrWhiteSpace(QuizUrl))
        {
            UrlErrorMessage = "Please enter a valid URL.";
            return;
        }
        IsUrlGenerating = true;
        await InvokeAsync(StateHasChanged);

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var userId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value
                   ?? user.FindFirst("sub")?.Value;

        try
        {
            var (quiz, error) = await PerplexityService.GenerateQuizFromUrlAsync(QuizUrl, userId);
            if (quiz == null)
            {
                UrlErrorMessage = error ?? "Failed to generate quiz from URL.";
                return;
            }
            quiz.Url = QuizUrl;
            var userQuizId = await UserQuizRepository.AddAsyncGetId(quiz);
            NavigationManager.NavigateTo($"/TakeAQuiz/{userQuizId}");
        }
        catch (Exception ex)
        {
            UrlErrorMessage = "An error occurred while generating or saving the quiz. Please try again later.";
            Logger.LogError(ex, "Exception during quiz save from URL.");
        }
        finally
        {
            IsUrlGenerating = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private void OnPromptDropdownChanged(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();
        if (!string.IsNullOrWhiteSpace(value))
        {
            UserPrompt = value;
        }
    }

    private void OnUrlDropdownChanged(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();
        if (!string.IsNullOrWhiteSpace(value))
        {
            QuizUrl = value;
        }
    }
}